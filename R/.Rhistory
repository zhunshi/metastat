install.packages(c("dplyr", "knitr", "openxlsx", "tibble"))
knitr::opts_chunk$set(echo = TRUE)
library(openxlsx)
library(dplyr)
library(tibble)
library(Maaslin2)
install.packages("BiocManager")
BiocManager::install("Maaslin2")
install.packages("openxlsx")
library(openxlsx)
install.packages("Rcpp")
library(openxlsx)
library(Rcpp)
update.packages(ask=FALSE, checkBuilt=TRUE)
library(openxlsx)
library(tibble)
library(Maaslin2)
library(openxlsx)
knitr::opts_chunk$set(echo = TRUE)
install.packages(c("dplyr", "knitr", "openxlsx", "tibble"))
install.packages("openxlsx")
library(dplyr)
install.packages("BiocManager")
install.packages("devtools")
BiocManager::install("Maaslin2")
library(openxlsx)
library(openxlsx)
library(Maaslin2)
library(dplyr)
library(tibble)
phe <- read.csv("../../../../../3.Results/01.phe/PG.n1320.phenotypes.2.csv",row.names = 1,header = T,check.names = F)
phe_diet1 <- read.csv("../../../../../3.Results/05.comparison/01.phe/diet_PCA/PCAs.centering.results.csv",row.names = 1,header = T,check.names = F)
sp <- read.table("../../../../../3.Results/02.Taxa/metaphlan2/PG.n1320.metaphlan2.species.clean.update.3.txt",row.names = 1,header = T,check.names = F)
phe$sex <- factor(phe$sex,levels = c(2,1),labels = c("Women","Men"))
phe <- phe[rownames(sp),]
knitr::opts_chunk$set(echo = TRUE)
library(openxlsx)
library(Maaslin2)
library(dplyr)
library(tibble)
phe <- read.csv("../../../../../3.Results/01.phe/PG.n1320.phenotypes.2.csv",row.names = 1,header = T,check.names = F)
phe_diet1 <- read.csv("../../../../../3.Results/05.comparison/01.phe/diet_PCA/PCAs.centering.results.csv",row.names = 1,header = T,check.names = F)
sp <- read.table("../../../../../3.Results/02.Taxa/metaphlan2/PG.n1320.metaphlan2.species.clean.update.3.txt",row.names = 1,header = T,check.names = F)
phe <- phe[rownames(sp),]
phe$sex <- factor(phe$sex,levels = c(2,1),labels = c("Women","Men"))
lst <- "age,sex,Time_Sit_day,Time_Sleep_grp,alcohol_group,smoking,menopause"
lst <- unlist(strsplit(lst,","))
lst.fat <- c("bmi","WC","L23_Visceral_fat_area","L23_Subcutaneous_fat_area",
"L45_Visceral_fat_area","L45_Subcutaneous_fat_area")
phe2 <- phe[,c(lst,lst.fat)]
colnames(phe)
knitr::opts_chunk$set(echo = TRUE)
library(openxlsx)
library(Maaslin2)
library(dplyr)
library(tibble)
phe <- read.csv("../../../../../3.Results/01.phe/PG.n1320.phenotypes.2.csv",row.names = 1,header = T,check.names = F)
phe_diet1 <- read.csv("../../../../../3.Results/05.comparison/01.phe/diet_PCA/PCAs.centering.results.csv",row.names = 1,header = T,check.names = F)
sp <- read.table("../../../../../3.Results/02.Taxa/metaphlan2/PG.n1320.metaphlan2.species.clean.update.3.txt",row.names = 1,header = T,check.names = F)
phe <- phe[rownames(sp),]
phe$sex <- factor(phe$sex,levels = c(2,1),labels = c("Women","Men"))
lst <- "age,sex,Time_Sit_day,Time_Sleep_grp,alcohol_group,smokgp,menopause"
lst <- unlist(strsplit(lst,","))
lst.fat <- c("bmi","WC","L23_Visceral_fat_area","L23_Subcutaneous_fat_area",
"L45_Visceral_fat_area","L45_Subcutaneous_fat_area")
phe2 <- phe[,c(lst,lst.fat)]
lst[!lst%in%colnames(phe)]
lst <- "age,sex,Time_Sit_day,Time_Sleep_grp,alcohol_group,smokegp,menopause"
lst <- unlist(strsplit(lst,","))
lst.fat <- c("bmi","WC","L23_Visceral_fat_area","L23_Subcutaneous_fat_area",
"L45_Visceral_fat_area","L45_Subcutaneous_fat_area")
phe2 <- phe[,c(lst,lst.fat)]
# factorize category variables
facs1 <- c("age",lst.fat)
facs2 <- lst[!lst%in%facs1]
for (i in facs2){
phe2[,i] <- as.factor(phe2[,i])
}
install.packages("ppcor")
install.packages("tidyr")
knitr::opts_chunk$set(echo = TRUE)
library(openxlsx)
library(Maaslin2)
library(dplyr)
library(tibble)
phe <- read.csv("../../../../../3.Results/01.phe/PG.n1320.phenotypes.2.csv",row.names = 1,header = T,check.names = F)
phe_diet1 <- read.csv("../../../../../3.Results/05.comparison/01.phe/diet_PCA/PCAs.centering.results.csv",row.names = 1,header = T,check.names = F)
sp <- read.table("../../../../../3.Results/02.Taxa/metaphlan2/PG.n1320.metaphlan2.species.clean.update.3.txt",row.names = 1,header = T,check.names = F)
phe <- phe[rownames(sp),]
phe$sex <- factor(phe$sex,levels = c(2,1),labels = c("Women","Men"))
lst <- "age,sex,Time_Sit_day,Time_Sleep_grp,alcohol_group,smokegp,menopause"
lst <- unlist(strsplit(lst,","))
lst.fat <- c("bmi","WC","L23_Visceral_fat_area","L23_Subcutaneous_fat_area",
"L45_Visceral_fat_area","L45_Subcutaneous_fat_area")
phe2 <- phe[,c(lst,lst.fat)]
# alcohol adjustment
phe2$alcohol_group[phe2$alcohol_group==2] <- 1
phe2$alcohol_group[phe2$alcohol_group==3] <- 2
# factorize category variables
facs <- c(
"sex","Time_Sit_day","Time_Sleep_grp","alcohol_group",
"smokegp","menopause"
)
for (i in facs2){
phe2[,i] <- as.factor(phe2[,i])
}
# adj
phe_diet1 <- phe_diet1[rownames(phe2),1:5]
phe.adj <- phe2[,lst]
phe.adj <- cbind(phe.adj,phe_diet1)
phe.adj.t <- phe.adj[,colnames(phe.adj)%in%c("alcohol_group","smokegp","menopause")]
knitr::opts_chunk$set(echo = TRUE)
library(openxlsx)
library(Maaslin2)
library(dplyr)
library(tibble)
phe <- read.csv("../../../../../3.Results/01.phe/PG.n1320.phenotypes.2.csv",row.names = 1,header = T,check.names = F)
phe_diet1 <- read.csv("../../../../../3.Results/05.comparison/01.phe/diet_PCA/PCAs.centering.results.csv",row.names = 1,header = T,check.names = F)
sp <- read.table("../../../../../3.Results/02.Taxa/metaphlan2/PG.n1320.metaphlan2.species.clean.update.3.txt",row.names = 1,header = T,check.names = F)
phe <- phe[rownames(sp),]
phe$sex <- factor(phe$sex,levels = c(2,1),labels = c("Women","Men"))
lst <- "age,sex,Time_Sit_day,Time_Sleep_grp,alcohol_group,smokegp,menopause"
lst <- unlist(strsplit(lst,","))
lst.fat <- c("bmi","WC","L23_Visceral_fat_area","L23_Subcutaneous_fat_area",
"L45_Visceral_fat_area","L45_Subcutaneous_fat_area")
phe2 <- phe[,c(lst,lst.fat)]
# alcohol adjustment
phe2$alcohol_group[phe2$alcohol_group==2] <- 1
phe2$alcohol_group[phe2$alcohol_group==3] <- 2
# factorize category variables
facs <- c(
"sex","Time_Sit_day","Time_Sleep_grp","alcohol_group",
"smokegp","menopause"
)
for (i in facs2){
phe2[,i] <- as.factor(phe2[,i])
}
# adj
phe_diet1 <- phe_diet1[rownames(phe2),1:5]
phe.adj <- phe2[,lst]
phe.adj <- cbind(phe.adj,phe_diet1)
phe.adj.t <- phe.adj[,1colnames(phe.adj)%in%c("alcohol_group","smokegp","menopause")]
phe.adj.t <- phe.adj[,!colnames(phe.adj)%in%c("alcohol_group","smokegp","menopause")]
phe.adj.m <- phe.adj[,!colnames(phe.adj)%in%c("sex","menopause")]
phe.adj.f <- phe.adj[,!colnames(phe.adj)%in%c("sex","alcohol_group","smokegp")]
datx <- phe2[,c(lst.fat)]
colnames(datx) <- c("BMI","WC","L23_VAT","L23_SAT","L45_VAT","L45_SAT")
phe.adj.m <- phe.adj[phe.adj$sex=="Men",!colnames(phe.adj)%in%c("sex","menopause")]
phe.adj.f <- phe.adj[phe.adj$sex=="Women",!colnames(phe.adj)%in%c("sex","alcohol_group","smokegp")]
datx <- phe2[,c(lst.fat)]
colnames(datx) <- c("BMI","WC","L23_VAT","L23_SAT","L45_VAT","L45_SAT")
myMaaslin <- function(datx,daty,outdir){
if(!dir.exists(outdir)){dir.create(outdir)}
inte <- intersect(rownames(datx),rownames(daty))
datx <- datx[inte,,drop=F]
daty <- daty[inte,,drop=F]
a <- Maaslin2(daty,datx,outdir,max_significance = 0.05,transform = "AST",
plot_heatmap = F,plot_scatter = F)
return(a)
}
ProcessingFun <- function(dat_x,dat_y,dat_adj,outdir){
for(i in colnames(dat_x)){
adj <- dat_adj
tmp <- cbind(adj,datx[rownames(adj),i,drop=F])
a <- myMaaslin(datx=tmp,daty=dat_y,outdir = paste0(outdir,i))
}
}
knitr::opts_chunk$set(echo = TRUE)
library(openxlsx)
library(Maaslin2)
library(dplyr)
library(tibble)
phe <- read.csv("../../../../../3.Results/01.phe/PG.n1320.phenotypes.2.csv",row.names = 1,header = T,check.names = F)
phe_diet1 <- read.csv("../../../../../3.Results/05.comparison/01.phe/diet_PCA/PCAs.centering.results.csv",row.names = 1,header = T,check.names = F)
sp <- read.table("../../../../../3.Results/02.Taxa/metaphlan2/PG.n1320.metaphlan2.species.clean.update.3.txt",row.names = 1,header = T,check.names = F)
phe <- phe[rownames(sp),]
phe$sex <- factor(phe$sex,levels = c(2,1),labels = c("Women","Men"))
lst <- "age,sex,Time_Sit_day,Time_Sleep_grp,alcohol_group,smokegp,menopause"
lst <- unlist(strsplit(lst,","))
lst.fat <- c("bmi","WC","L23_Visceral_fat_area","L23_Subcutaneous_fat_area",
"L45_Visceral_fat_area","L45_Subcutaneous_fat_area")
phe2 <- phe[,c(lst,lst.fat)]
# alcohol adjustment
phe2$alcohol_group[phe2$alcohol_group==2] <- 1
phe2$alcohol_group[phe2$alcohol_group==3] <- 2
# factorize category variables
facs <- c(
"sex","Time_Sit_day","Time_Sleep_grp","alcohol_group",
"smokegp","menopause"
)
for (i in facs2){
phe2[,i] <- as.factor(phe2[,i])
}
ProcessingFun <- function(dat_x,dat_y,dat_adj,outdir){
dir.create(outdir)
for(i in colnames(dat_x)){
adj <- dat_adj
tmp <- cbind(adj,datx[rownames(adj),i,drop=F])
a <- myMaaslin(datx=tmp,daty=dat_y,outdir = paste0(outdir,i))
}
}
outDir <- "./out.continous/"
dir.create(outDir)
res.t <- ProcessingFun(datx,sp,phe.adj.t,paste0(outDir,"Total/"))
knitr::opts_chunk$set(echo = TRUE)
library(openxlsx)
library(Maaslin2)
library(dplyr)
library(tibble)
phe <- read.csv("../../../../../3.Results/01.phe/PG.n1320.phenotypes.2.csv",row.names = 1,header = T,check.names = F)
phe_diet1 <- read.csv("../../../../../3.Results/05.comparison/01.phe/diet_PCA/PCAs.centering.results.csv",row.names = 1,header = T,check.names = F)
sp <- read.table("../../../../../3.Results/02.Taxa/metaphlan2/PG.n1320.metaphlan2.species.clean.update.3.txt",row.names = 1,header = T,check.names = F)
phe <- phe[rownames(sp),]
phe$sex <- factor(phe$sex,levels = c(2,1),labels = c("Women","Men"))
lst <- "age,sex,Time_Sit_day,Time_Sleep_grp,alcohol_group,smokegp,menopause"
lst <- unlist(strsplit(lst,","))
lst.fat <- c("bmi","WC","L23_Visceral_fat_area","L23_Subcutaneous_fat_area",
"L45_Visceral_fat_area","L45_Subcutaneous_fat_area")
phe2 <- phe[,c(lst,lst.fat)]
# alcohol adjustment
phe2$alcohol_group[phe2$alcohol_group==2] <- 1
phe2$alcohol_group[phe2$alcohol_group==3] <- 2
# factorize category variables
facs <- c(
"sex","Time_Sit_day","Time_Sleep_grp","alcohol_group",
"smokegp","menopause"
)
for (i in facs){
phe2[,i] <- as.factor(phe2[,i])
}
# adj
phe_diet1 <- phe_diet1[rownames(phe2),1:5]
phe.adj <- phe2[,lst]
phe.adj <- cbind(phe.adj,phe_diet1)
phe.adj.t <- phe.adj[,!colnames(phe.adj)%in%c("alcohol_group","smokegp","menopause")]
phe.adj.m <- phe.adj[phe.adj$sex=="Men",!colnames(phe.adj)%in%c("sex","menopause")]
phe.adj.f <- phe.adj[phe.adj$sex=="Women",!colnames(phe.adj)%in%c("sex","alcohol_group","smokegp")]
datx <- phe2[,c(lst.fat)]
colnames(datx) <- c("BMI","WC","L23_VAT","L23_SAT","L45_VAT","L45_SAT")
datx <- phe2[,c(lst.fat)]
colnames(datx) <- c("BMI","WC","L23_VAT","L23_SAT","L45_VAT","L45_SAT")
myMaaslin <- function(datx,daty,outdir){
if(!dir.exists(outdir)){dir.create(outdir)}
inte <- intersect(rownames(datx),rownames(daty))
datx <- datx[inte,,drop=F]
daty <- daty[inte,,drop=F]
a <- Maaslin2(daty,datx,outdir,max_significance = 0.05,transform = "AST",
plot_heatmap = F,plot_scatter = F)
return(a)
}
ProcessingFun <- function(dat_x,dat_y,dat_adj,outdir){
dir.create(outdir)
for(i in colnames(dat_x)){
adj <- dat_adj
tmp <- cbind(adj,datx[rownames(adj),i,drop=F])
a <- myMaaslin(datx=tmp,daty=dat_y,outdir = paste0(outdir,i))
}
}
outDir <- "./out.continous/"
dir.create(outDir)
res.t <- ProcessingFun(datx,sp,phe.adj.t,paste0(outDir,"Total/"))
res.m <- ProcessingFun(datx,sp,phe.adj.t,paste0(outDir,"Men/"))
res.f <- ProcessingFun(datx,sp,phe.adj.t,paste0(outDir,"Women/"))
ReadTable <- function(Path){
dirs <- dir(Path)
files <- sapply(dirs,function(x) paste0(Path,"/",x,"/all_results.tsv"))
datlst <- lapply(files,function(x) read.table(x,header = T,check.names = F,sep = "\t"))
datlst <- lapply(
datlst,function(dat){dat %>% group_by(metadata) %>% mutate(BH=p.adjust(pval,method = "BH"))})
names(datlst) <- dirs
return(datlst)
}
datlst.t <- ReadTable(paste0(outDir,"Total"))
datlst.m <- ReadTable(paste0(outDir,"Men"))
datlst.f <- ReadTable(paste0(outDir,"Women"))
a <- datlst.t$BMI
View(a)
setwd("D:/Projects/metastat/R")
devtools::document()
devtools::install_github("zhunshi/metastat")
library(metastat)
?ReAdjustedMaaslin2
?ReAdjustBHMaaslin2
?ReAdjustBHMaaslin2
?ReAdjustBHMaaslin2
install.packages(c("ggpubr", "tidyverse", "VennDiagram"))
